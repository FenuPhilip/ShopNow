{% extends 'base.html' %}
{% block title %}Checkout — ShopNow{% endblock %}
{% block content %}
<div class="container py-5">
  <h2 class="fw-bold mb-4"><i class="bi bi-truck me-2"></i>Checkout</h2>

  <!-- Progress -->
  <div class="d-flex align-items-center mb-5">
    <div class="text-warning fw-bold">1. Shipping</div>
    <div class="flex-grow-1 border-top mx-3"></div>
    <div class="text-muted">2. Payment</div>
    <div class="flex-grow-1 border-top mx-3"></div>
    <div class="text-muted">3. Confirmation</div>
  </div>

  <div class="row g-4">
    <div class="col-lg-7">
      <!-- Saved Addresses -->
      {% if addresses %}
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Saved Addresses</h6>
          <div class="row g-2">
            {% for address in addresses %}
            {% if address.address_type == 'shipping' %}
            <div class="col-12">
              <div class="border rounded p-3 address-select" style="cursor:pointer;"
                   onclick="fillAddress('{{ address.full_name }}','{{ address.address_line1 }}','{{ address.address_line2 }}','{{ address.city }}','{{ address.state }}','{{ address.postal_code }}','{{ address.country }}','{{ address.phone }}')">
                <div class="d-flex justify-content-between">
                  <strong>{{ address.full_name }}</strong>
                  {% if address.is_default %}<span class="badge bg-success">Default</span>{% endif %}
                </div>
                <small class="text-muted">{{ address.address_line1 }}, {{ address.city }}, {{ address.state }} {{ address.postal_code }}</small>
              </div>
            </div>
            {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Shipping Form -->
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-3">Shipping Address</h5>
          <form method="POST" id="checkoutForm">
            {% csrf_token %}
            <div class="row g-3">
              {% for field in form %}
              <div class="col-{% if field.name in 'city,state,postal_code' %}4{% elif field.name == 'notes' %}12{% else %}6{% endif %}">
                <label class="form-label fw-semibold">{{ field.label }}</label>
                {{ field }}
                {% if field.errors %}<div class="text-danger small">{{ field.errors }}</div>{% endif %}
              </div>
              {% endfor %}
            </div>
            <button type="submit" class="btn btn-dark btn-lg w-100 mt-4">Continue to Payment <i class="bi bi-arrow-right ms-2"></i></button>
          </form>
        </div>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="col-lg-5">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Order Summary</h5>
          {% for item in cart.items.all %}
          <div class="d-flex align-items-center gap-2 mb-2">
            <div class="flex-grow-1">
              <span class="fw-semibold">{{ item.product.name }}</span>
              <small class="text-muted"> × {{ item.quantity }}</small>
            </div>
            <span>₹{{ item.line_total }}</span>
          </div>
          {% endfor %}
          <hr>
          <div class="d-flex justify-content-between"><span class="text-muted">Subtotal</span><span>₹{{ cart.subtotal }}</span></div>
          {% if discount %}<div class="d-flex justify-content-between text-success"><span>Discount</span><span>-₹{{ discount }}</span></div>{% endif %}
          <div class="d-flex justify-content-between"><span class="text-muted">Shipping</span><span class="text-success">Free</span></div>
          <hr>
          <div class="d-flex justify-content-between fw-bold fs-5"><span>Total</span><span>₹{{ total }}</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function fillAddress(name, line1, line2, city, state, postal, country, phone) {
  document.querySelector('[name=shipping_name]').value = name;
  document.querySelector('[name=address_line1]').value = line1;
  document.querySelector('[name=address_line2]').value = line2;
  document.querySelector('[name=city]').value = city;
  document.querySelector('[name=state]').value = state;
  document.querySelector('[name=postal_code]').value = postal;
  document.querySelector('[name=country]').value = country;
  document.querySelector('[name=phone]').value = phone;
}
</script>
{% endblock %}
