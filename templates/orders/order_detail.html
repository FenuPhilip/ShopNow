{% extends 'base.html' %}
{% block title %}Order {{ order.order_number }} — ShopNow{% endblock %}
{% block content %}
<div class="container py-5">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <a href="{% url 'order_list' %}" class="btn btn-sm btn-outline-secondary mb-2"><i class="bi bi-arrow-left me-1"></i>Back</a>
      <h3 class="fw-bold mb-0">Order {{ order.order_number }}</h3>
      <small class="text-muted">Placed on {{ order.created_at|date:"M d, Y, g:i A" }}</small>
    </div>
    <div>
      <span class="badge bg-{{ order.get_status_badge_class }} px-3 py-2 fs-6">{{ order.get_status_display }}</span>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <!-- Order Items -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Items Ordered</h5>
          {% for item in order.items.all %}
          <div class="d-flex gap-3 align-items-center border-bottom pb-3 mb-3">
            <div class="fw-semibold flex-grow-1">
              {{ item.product_name }}
              <small class="text-muted d-block">SKU: {{ item.product_sku }}</small>
            </div>
            <div class="text-muted">₹{{ item.unit_price }} × {{ item.quantity }}</div>
            <div class="fw-bold">₹{{ item.line_total }}</div>
          </div>
          {% endfor %}
          <div class="d-flex justify-content-between"><span class="text-muted">Subtotal</span><span>₹{{ order.subtotal }}</span></div>
          {% if order.discount_amount %}<div class="d-flex justify-content-between text-success"><span>Discount</span><span>-₹{{ order.discount_amount }}</span></div>{% endif %}
          <div class="d-flex justify-content-between"><span class="text-muted">Shipping</span><span class="text-success">Free</span></div>
          <hr>
          <div class="d-flex justify-content-between fw-bold fs-5"><span>Total</span><span>₹{{ order.total }}</span></div>
        </div>
      </div>

      <!-- Order Status Timeline -->
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Order Timeline</h5>
          {% for history in status_history %}
          <div class="d-flex gap-3 mb-3">
            <div class="text-center">
              <div class="bg-dark text-white rounded-circle d-flex align-items-center justify-content-center" style="width:32px;height:32px;font-size:12px;">
                {{ forloop.counter }}
              </div>
              {% if not forloop.last %}<div class="border-start border-2 ms-2" style="height:30px;"></div>{% endif %}
            </div>
            <div>
              <strong>{{ history.get_status_display }}</strong>
              {% if history.note %}<p class="text-muted small mb-1">{{ history.note }}</p>{% endif %}
              <small class="text-muted">{{ history.changed_at|date:"M d, Y, g:i A" }}</small>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- Shipping Address -->
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h6 class="fw-bold mb-2"><i class="bi bi-geo-alt me-2"></i>Shipping Address</h6>
          <p class="mb-1"><strong>{{ order.shipping_name }}</strong></p>
          <p class="text-muted mb-1">{{ order.shipping_address_line1 }}{% if order.shipping_address_line2 %}, {{ order.shipping_address_line2 }}{% endif %}</p>
          <p class="text-muted mb-1">{{ order.shipping_city }}, {{ order.shipping_state }} {{ order.shipping_postal_code }}</p>
          <p class="text-muted mb-1">{{ order.shipping_country }}</p>
          <p class="text-muted"><i class="bi bi-telephone me-1"></i>{{ order.shipping_phone }}</p>
        </div>
      </div>

      <!-- Payment -->
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h6 class="fw-bold mb-2"><i class="bi bi-credit-card me-2"></i>Payment</h6>
          {% for payment in payments %}
          <div class="d-flex justify-content-between mb-1">
            <span class="text-muted">{{ payment.get_payment_method_display }}</span>
            <span class="badge bg-{% if payment.status == 'success' %}success{% elif payment.status == 'failed' %}danger{% else %}warning{% endif %}">
              {{ payment.get_status_display }}
            </span>
          </div>
          {% endfor %}
          <p class="fw-bold mb-0">₹{{ order.total }}</p>
        </div>
      </div>

      <!-- Tracking -->
      {% if order.tracking_number %}
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h6 class="fw-bold mb-2"><i class="bi bi-truck me-2"></i>Tracking</h6>
          <p class="mb-0 fw-semibold">{{ order.tracking_number }}</p>
        </div>
      </div>
      {% endif %}

      <!-- Cancel -->
      {% if order.status in 'pending,confirmed' %}
      <form method="POST" action="{% url 'cancel_order' order.order_number %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('Cancel this order?')">
          <i class="bi bi-x-circle me-2"></i>Cancel Order
        </button>
      </form>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
