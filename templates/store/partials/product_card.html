<div class="col-6 col-md-4 col-lg-3">
  <div class="card border-0 shadow-sm h-100 product-card">
    <div class="position-relative">
      {% if product.image %}
      <img src="{{ product.image.url }}" class="card-img-top" style="height:220px;object-fit:cover;" alt="{{ product.name }}">
      {% else %}
      <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height:220px;">
        <i class="bi bi-image text-muted" style="font-size:3rem;"></i>
      </div>
      {% endif %}
      {% if product.discount_percentage %}
      <span class="badge bg-danger position-absolute top-0 start-0 m-2">-{{ product.discount_percentage }}%</span>
      {% endif %}
      {% if product.is_featured %}
      <span class="badge bg-warning text-dark position-absolute top-0 end-0 m-2">⭐ Featured</span>
      {% endif %}
      {% if not product.is_in_stock %}
      <div class="position-absolute inset-0 bg-dark bg-opacity-50 d-flex align-items-center justify-content-center" style="top:0;left:0;right:0;bottom:0;">
        <span class="badge bg-dark fs-6">Out of Stock</span>
      </div>
      {% endif %}
    </div>
    <div class="card-body d-flex flex-column">
      <small class="text-muted">{{ product.category.name }}</small>
      <h6 class="card-title mb-1 mt-1">
        <a href="{{ product.get_absolute_url }}" class="text-decoration-none text-dark fw-semibold">{{ product.name }}</a>
      </h6>
      <!-- Rating -->
      <div class="mb-2">
        {% with product.average_rating as avg %}
        {% for i in "12345" %}
          {% if forloop.counter <= avg %}
          <i class="bi bi-star-fill text-warning small"></i>
          {% else %}
          <i class="bi bi-star text-warning small"></i>
          {% endif %}
        {% endfor %}
        <small class="text-muted">({{ product.review_count }})</small>
        {% endwith %}
      </div>
      <div class="mt-auto">
        <div class="d-flex align-items-center gap-2 mb-2">
          <span class="fw-bold text-dark fs-5">₹{{ product.effective_price }}</span>
          {% if product.discount_price %}
          <span class="text-muted text-decoration-line-through small">₹{{ product.price }}</span>
          {% endif %}
        </div>
        <div class="d-flex gap-2">
          {% if product.is_in_stock %}
          <form method="POST" action="{% url 'add_to_cart' product.id %}" class="flex-grow-1">
            {% csrf_token %}
            <input type="hidden" name="quantity" value="1">
            <button type="submit" class="btn btn-dark btn-sm w-100">
              <i class="bi bi-cart-plus me-1"></i>Add to Cart
            </button>
          </form>
          {% else %}
          <button class="btn btn-secondary btn-sm flex-grow-1" disabled>Out of Stock</button>
          {% endif %}
          {% if user.is_authenticated %}
          <a href="{% url 'toggle_wishlist' product.id %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-heart"></i>
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
